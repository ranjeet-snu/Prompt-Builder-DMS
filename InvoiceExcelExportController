public class InvoiceExcelExportController {
    
    public String fileName { get; set; }
    public List<String> vendorSheets { get; set; }
    public Map<String, List<InvoiceWrapper>> invoicesByVendor { get; set; }
    
    public class InvoiceWrapper {
        public String invoiceNumber { get; set; }
        public String invoiceDate { get; set; }
        public String invoiceValue { get; set; }
        public String dealerName { get; set; }
        public String subdealerName { get; set; }
        public String subdealerGST { get; set; }
        public List<ProductLineWrapper> productLines { get; set; }
        public List<String> visibleColumns { get; set; }
        public GstSummaryWrapper gstSummary { get; set; }
        
        public InvoiceWrapper() {
            this.productLines = new List<ProductLineWrapper>();
            this.visibleColumns = new List<String>();
        }
    }
    
    public class ProductLineWrapper {
        public String productName { get; set; }
        public String hsnSac { get; set; }
        public String quantity { get; set; }
        public String quantityUnit { get; set; }
        public String unitPrice { get; set; }
        public String rateUnit { get; set; }
        public String discountPercent { get; set; }
        public String additionalDiscountPercent { get; set; }
        public String taxPercent { get; set; }
        public String taxAmount { get; set; }
        public String lineAmount { get; set; }
    }
    
    // CORRECTED: GST Summary Wrapper with properties instead of methods
    public class GstSummaryWrapper {
        public String taxableValue { get; set; }
        public String sgstPercent { get; set; }
        public String sgstAmount { get; set; }
        public String cgstPercent { get; set; }
        public String cgstAmount { get; set; }
        public String roundOff { get; set; }
        public String finalInvoiceValue { get; set; }
        
        // Convert methods to properties for Visualforce access
        public Boolean hasSgst {
            get {
                return String.isNotBlank(sgstPercent) || String.isNotBlank(sgstAmount);
            }
        }
        
        public Boolean hasCgst {
            get {
                return String.isNotBlank(cgstPercent) || String.isNotBlank(cgstAmount);
            }
        }
        
        public Boolean hasRoundOff {
            get {
                return String.isNotBlank(roundOff);
            }
        }
        
        public Boolean hasFinalValue {
            get {
                return String.isNotBlank(finalInvoiceValue);
            }
        }
    }
    
    public InvoiceExcelExportController() {
        vendorSheets = new List<String>();
        invoicesByVendor = new Map<String, List<InvoiceWrapper>>();
        
        // Get invoice records
        List<Document_Extraction__c> invoices = [
            SELECT Id, Invoice_Number__c, Invoice_Date__c, Invoice_Value__c,
                   Dealer_Enterprise_Name__c, Subdealer_Enterprise_Name__c,
                   Subdealer_GST_Number__c, Product_Details__c, GST__c
            FROM Document_Extraction__c
            ORDER BY Dealer_Enterprise_Name__c, Invoice_Number__c
        ];
        
        for (Document_Extraction__c inv : invoices) {
            // Skip invoices without product details
            if (String.isBlank(inv.Product_Details__c)) {
                continue;
            }
            
            String vendor = inv.Dealer_Enterprise_Name__c != null ? 
                           inv.Dealer_Enterprise_Name__c : 'Unknown Vendor';
            
            if (!invoicesByVendor.containsKey(vendor)) {
                vendorSheets.add(vendor);
                invoicesByVendor.put(vendor, new List<InvoiceWrapper>());
            }
            
            InvoiceWrapper wrapper = new InvoiceWrapper();
            wrapper.invoiceNumber = inv.Invoice_Number__c;
            wrapper.invoiceDate = inv.Invoice_Date__c != null ? 
                                 String.valueOf(inv.Invoice_Date__c) : '';
            wrapper.invoiceValue = inv.Invoice_Value__c != null ? 
                                  String.valueOf(inv.Invoice_Value__c) : '';
            wrapper.dealerName = inv.Dealer_Enterprise_Name__c;
            wrapper.subdealerName = inv.Subdealer_Enterprise_Name__c;
            wrapper.subdealerGST = inv.Subdealer_GST_Number__c;
            
            // Parse product details JSON
            parseProductDetails(inv.Product_Details__c, wrapper);
            
            // Parse GST Summary
            parseGstSummary(inv.GST__c, wrapper);
            
            invoicesByVendor.get(vendor).add(wrapper);
        }
        
        fileName = 'InvoiceExport_' + System.now().format('yyyyMMdd_HHmmss');
    }
    
    private void parseProductDetails(String productJson, InvoiceWrapper wrapper) {
        try {
            List<Object> products = (List<Object>) JSON.deserializeUntyped(productJson);
            
            Set<String> columnsWithData = new Set<String>();
            
            for (Object prodObj : products) {
                Map<String, Object> product = (Map<String, Object>) prodObj;
                
                ProductLineWrapper line = new ProductLineWrapper();
                
                // Extract all fields
                line.productName = getStringValue(product, 'productName');
                line.hsnSac = getStringValue(product, 'hsnSac');
                line.quantity = getStringValue(product, 'quantity');
                line.quantityUnit = getStringValue(product, 'quantityUnit');
                line.unitPrice = getStringValue(product, 'unitPrice');
                line.rateUnit = getStringValue(product, 'rateUnit');
                line.discountPercent = getStringValue(product, 'discountPercent');
                line.additionalDiscountPercent = getStringValue(product, 'additionalDiscountPercent');
                line.taxPercent = getStringValue(product, 'taxPercent');
                line.taxAmount = getStringValue(product, 'taxAmount');
                line.lineAmount = getStringValue(product, 'lineAmount');
                
                // Track non-null columns
                if (String.isNotBlank(line.productName)) columnsWithData.add('productName');
                if (String.isNotBlank(line.hsnSac)) columnsWithData.add('hsnSac');
                if (String.isNotBlank(line.quantity)) columnsWithData.add('quantity');
                if (String.isNotBlank(line.quantityUnit)) columnsWithData.add('quantityUnit');
                if (String.isNotBlank(line.unitPrice)) columnsWithData.add('unitPrice');
                if (String.isNotBlank(line.rateUnit)) columnsWithData.add('rateUnit');
                if (String.isNotBlank(line.discountPercent)) columnsWithData.add('discountPercent');
                if (String.isNotBlank(line.additionalDiscountPercent)) columnsWithData.add('additionalDiscountPercent');
                if (String.isNotBlank(line.taxPercent)) columnsWithData.add('taxPercent');
                if (String.isNotBlank(line.taxAmount)) columnsWithData.add('taxAmount');
                if (String.isNotBlank(line.lineAmount)) columnsWithData.add('lineAmount');
                
                wrapper.productLines.add(line);
            }
            
            // Build visible columns list in desired order
            List<String> allColumns = new List<String>{
                'productName', 'hsnSac', 'quantity', 'quantityUnit', 
                'unitPrice', 'rateUnit', 'discountPercent', 
                'additionalDiscountPercent', 'taxPercent', 'taxAmount', 'lineAmount'
            };
            
            for (String col : allColumns) {
                if (columnsWithData.contains(col)) {
                    wrapper.visibleColumns.add(col);
                }
            }
            
        } catch (Exception e) {
            System.debug('Error parsing product JSON: ' + e.getMessage());
        }
    }
    
    // Parse GST Summary from JSON
    private void parseGstSummary(String gstJson, InvoiceWrapper wrapper) {
        if (String.isBlank(gstJson)) {
            return;
        }
        
        try {
            Map<String, Object> gstData = (Map<String, Object>) JSON.deserializeUntyped(gstJson);
            
            GstSummaryWrapper gst = new GstSummaryWrapper();
            gst.taxableValue = getStringValue(gstData, 'taxableValue');
            gst.sgstPercent = getStringValue(gstData, 'sgstPercent');
            gst.sgstAmount = getStringValue(gstData, 'sgstAmount');
            gst.cgstPercent = getStringValue(gstData, 'cgstPercent');
            gst.cgstAmount = getStringValue(gstData, 'cgstAmount');
            gst.roundOff = getStringValue(gstData, 'roundOff');
            gst.finalInvoiceValue = getStringValue(gstData, 'finalInvoiceValue');
            
            wrapper.gstSummary = gst;
            
        } catch (Exception e) {
            System.debug('Error parsing GST JSON: ' + e.getMessage());
        }
    }
    
    private String getStringValue(Map<String, Object> dataMap, String key) {
        Object value = dataMap.get(key);
        if (value == null) return null;
        String strValue = String.valueOf(value);
        // Return null if value is empty string
        return String.isNotBlank(strValue) ? strValue : null;
    }
    
    public String getColumnLabel(String columnName) {
        Map<String, String> labelMap = new Map<String, String>{
            'productName' => 'Product Name',
            'hsnSac' => 'HSN/SAC',
            'quantity' => 'Quantity',
            'quantityUnit' => 'Unit',
            'unitPrice' => 'Unit Price',
            'rateUnit' => 'Rate Unit',
            'discountPercent' => 'Discount %',
            'additionalDiscountPercent' => 'Add. Discount %',
            'taxPercent' => 'Tax %',
            'taxAmount' => 'Tax Amount',
            'lineAmount' => 'Line Amount'
        };
        return labelMap.containsKey(columnName) ? labelMap.get(columnName) : columnName;
    }
}
